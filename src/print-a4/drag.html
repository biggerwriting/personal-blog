<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>可变形画布</title>
    <style>
        #canvas {
            width: 800px;
            height: 600px;
            border: 1px solid #ccc;
            position: relative;
            overflow: hidden;
        }

        .element {
            position: absolute;
            border: 1px dashed #999;
            cursor: move;
        }

        .resize-handle {
            width: 10px;
            height: 10px;
            background: #09f;
            position: absolute;
            right: 0;
            bottom: 0;
            cursor: nwse-resize;
        }

        .controls {
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="controls">
        <button onclick="addElement('text')">添加文本</button>
        <button onclick="addElement('image')">添加图片</button>
        <button onclick="addElement('rectangle')">添加矩形</button>
        <button onclick="exportCanvas()">导出画布</button>
    </div>
    <div id="canvas"></div>

    <script>
        let selectedElement = null;
        let isDragging = false;
        let isResizing = false;
        let startX, startY, startWidth, startHeight;

        // 添加元素到画布
        function addElement(type) {
            const canvas = document.getElementById('canvas');
            const element = document.createElement('div');
            element.className = 'element';

            // 设置初始位置和大小
            element.style.left = '100px';
            element.style.top = '100px';
            element.style.width = '150px';
            element.style.height = '100px';

            // 根据类型设置内容
            switch (type) {
                case 'text':
                    element.innerHTML = '<div contenteditable="true">双击编辑文本</div>';
                    element.style.backgroundColor = '#fff';
                    // 阻止事件冒泡到父元素
                    element.querySelector('div').addEventListener('mousedown', function (e) {
                        e.stopPropagation();
                    });
                    break;
                case 'image':
                    element.innerHTML = '<img src="https://via.placeholder.com/150x100" style="width:100%;height:100%;object-fit:cover;">';
                    break;
                case 'rectangle':
                    element.style.backgroundColor = '#e0e0e0';
                    break;
            }

            // 添加调整大小手柄
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            element.appendChild(resizeHandle);

            // 添加事件监听
            element.addEventListener('mousedown', startDrag);
            resizeHandle.addEventListener('mousedown', startResize);

            canvas.appendChild(element);
            selectElement(element);
        }

        // 选择元素
        function selectElement(element) {
            if (selectedElement) {
                selectedElement.style.border = '1px dashed #999';
            }
            selectedElement = element;
            element.style.border = '2px solid #09f';
        }

        // 开始拖动
        function startDrag(e) {
            if (e.target.className === 'resize-handle') return;

            isDragging = true;
            selectedElement = e.currentTarget;
            startX = e.clientX;
            startY = e.clientY;
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            e.preventDefault();
        }

        // 拖动过程
        function drag(e) {
            if (isDragging) {
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;

                selectedElement.style.left = (parseInt(selectedElement.style.left) + dx) + 'px';
                selectedElement.style.top = (parseInt(selectedElement.style.top) + dy) + 'px';

                startX = e.clientX;
                startY = e.clientY;
            } else if (isResizing) {
                const dx = e.clientX - startX;
                const newWidth = startWidth + dx;
                const newHeight = startHeight + dx * (startHeight / startWidth);

                if (newWidth > 50 && newHeight > 50) {
                    selectedElement.style.width = newWidth + 'px';
                    selectedElement.style.height = newHeight + 'px';
                }
            }
        }

        // 开始调整大小
        function startResize(e) {
            isResizing = true;
            selectedElement = e.currentTarget.parentElement;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(selectedElement.style.width);
            startHeight = parseInt(selectedElement.style.height);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);
            e.preventDefault();
        }

        // 结束操作
        function endDrag() {
            isDragging = false;
            isResizing = false;
            document.removeEventListener('mousemove', drag);
            document.removeEventListener('mouseup', endDrag);
        }

        // 画布点击事件
        document.getElementById('canvas').addEventListener('click', function (e) {
            if (e.target === this) {
                if (selectedElement) {
                    selectedElement.style.border = '1px dashed #999';
                    selectedElement = null;
                }
            }
        });

        // 导出画布为图片
        function exportCanvas() {
            const canvas = document.getElementById('canvas');
            const elements = canvas.querySelectorAll('.element');
            
            // 创建临时canvas
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.offsetWidth;
            tempCanvas.height = canvas.offsetHeight;
            const ctx = tempCanvas.getContext('2d');
            
            // 绘制背景
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // 绘制所有元素
            elements.forEach(element => {
                const rect = element.getBoundingClientRect();
                const canvasRect = canvas.getBoundingClientRect();
                
                const x = rect.left - canvasRect.left;
                const y = rect.top - canvasRect.top;
                const width = rect.width;
                const height = rect.height;
                
                // 创建临时canvas绘制元素内容
                const elementCanvas = document.createElement('canvas');
                elementCanvas.width = width;
                elementCanvas.height = height;
                const elementCtx = elementCanvas.getContext('2d');
                
                // 绘制元素背景
                elementCtx.fillStyle = window.getComputedStyle(element).backgroundColor;
                elementCtx.fillRect(0, 0, width, height);
                
                // 绘制元素内容
                if (element.querySelector('img')) {
                    const img = element.querySelector('img');
                    elementCtx.drawImage(img, 0, 0, width, height);
                } else if (element.querySelector('div')) {
                    const text = element.querySelector('div');
                    elementCtx.font = '14px Arial';
                    elementCtx.fillStyle = 'black';
                    elementCtx.fillText(text.textContent, 10, 20);
                }
                
                // 将元素绘制到主canvas
                ctx.drawImage(elementCanvas, x, y, width, height);
            });
            
            // 创建下载链接
            const link = document.createElement('a');
            link.download = 'canvas-export.png';
            link.href = tempCanvas.toDataURL('image/png');
            link.click();
        }
    </script>
</body>

</html>