<!DOCTYPE html>
<html>

<head>
    <title>Canvas Image Export</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        #canvas-container {
            width: 800px;
            height: 600px;
            border: 2px dashed #ccc;
            margin: 20px auto;
            position: relative;
        }

        .draggable-image {
            position: absolute;
            max-width: 200px;
            max-height: 200px;
            cursor: move;
        }

        .controls {
            text-align: center;
            margin: 20px;
        }

        button {
            padding: 10px 20px;
            margin: 0 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .draggable-image {
            position: absolute;
            max-width: 200px;
            max-height: 200px;
            cursor: move;
            user-select: none;
            /* 新增：防止拖拽时选中图片 */
        }
    </style>
</head>

<body>
    <div class="controls">
        <input type="file" id="imageInput" accept="image/*" hidden>
        <button onclick="document.getElementById('imageInput').click()">添加图片</button>
        <button onclick="exportCanvas()">导出图片</button>
    </div>

    <div id="canvas-container"></div>

    <script>
        // 新增拖拽功能相关变量
        let isDragging = false;
        let currentX;
        let currentY;
        let initialX;
        let initialY;
        let xOffset = 0;
        let yOffset = 0;
        let selectedElement = null;

        // 新增：拖拽事件处理
        function handleMouseDown(e) {
            if (e.target.classList.contains('draggable-image')) {
                selectedElement = e.target;
                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (selectedElement !== null) {
                    isDragging = true;

                    // 获取元素初始位置
                    const rect = selectedElement.getBoundingClientRect();
                    currentX = rect.left;
                    currentY = rect.top;
                }
            }
        }

        function handleMouseMove(e) {
            if (isDragging && selectedElement) {
                e.preventDefault();
                currentX = e.clientX - initialX;
                currentY = e.clientY - initialY;

                xOffset = currentX;
                yOffset = currentY;

                setTranslate(currentX, currentY, selectedElement);
            }
        }

        function handleMouseUp() {
            initialX = currentX;
            initialY = currentY;
            isDragging = false;
            selectedElement = null;
        }

        function setTranslate(xPos, yPos, el) {
            el.style.left = xPos + 'px';
            el.style.top = yPos + 'px';
        }

        // 在图片加载完成后绑定事件
        function addImageToCanvas(imageSrc) {
            const img = new Image();
            img.onload = function () {
                img.classList.add('draggable-image');
                img.style.left = '50px';
                img.style.top = '50px';

                // 添加事件监听
                img.addEventListener('mousedown', handleMouseDown);
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);

                document.getElementById('canvas-container').appendChild(img);
            };
            img.src = imageSrc;
        }

        // 图片上传处理
        document.getElementById('imageInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    addImageToCanvas(event.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // 添加图片到画布
        function addImageToCanvas(imageSrc) {
            const img = new Image();
            img.onload = function () {
                img.classList.add('draggable-image');
                img.style.left = '50px';
                img.style.top = '50px';
                document.getElementById('canvas-container').appendChild(img);
            };
            img.src = imageSrc;
        }

        // 导出为图片
        function exportCanvas() {
            html2canvas(document.querySelector("#canvas-container"), {
                allowTaint: true,
                useCORS: true,
                scale: 2 // 提高导出图片分辨率
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'exported-image.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // 拖放功能
        const container = document.getElementById('canvas-container');

        container.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        container.addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    addImageToCanvas(event.target.result);
                };
                reader.readAsDataURL(file);
            }
        });
    </script>
</body>

</html>